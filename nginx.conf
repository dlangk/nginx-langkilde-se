# ============================================================================
# Top-level NGINX configuration
# ============================================================================
# The "events" block is required syntactically by NGINX, even if empty.
# For this setup we do not need to tune any worker connection settings here.
events {}


# ============================================================================
# HTTP configuration (all HTTP and HTTPS servers live inside this block)
# ============================================================================
http {
    # ------------------------------------------------------------------------
    # DNS resolver configuration (Docker-specific)
    # ------------------------------------------------------------------------
    # This tells NGINX to use Docker's embedded DNS server for resolving
    # upstream hostnames (like "yatzy-frontend", "yatzy-backend") on the
    # "shared_network" Docker network. The "valid=30s" setting means that
    # resolved addresses are cached for 30 seconds before being re-resolved.
    resolver 127.0.0.11 valid=30s;


    # ------------------------------------------------------------------------
    # HTTP server (port 80) - redirect all traffic to HTTPS on canonical host
    # ------------------------------------------------------------------------
    # This server listens on plain HTTP and has two responsibilities:
    #   1. Serve ACME HTTP-01 challenge files for Let's Encrypt via /webroot
    #   2. Redirect all other HTTP traffic to HTTPS on the canonical hostname
    #
    # Having a single HTTP listener ensures all HTTP requests are upgraded to
    # HTTPS, which is good for security and simplifies analytics.
    server {
        listen 80;
        server_name langkilde.se www.langkilde.se daniel.langkilde.se www.daniel.langkilde.se;

        # --------------------------------------------------------------------
        # ACME HTTP-01 challenge location
        # --------------------------------------------------------------------
        # Let's Encrypt validation requests (e.g. for certbot) hit paths under:
        #   /.well-known/acme-challenge/
        #
        # These must be served as static files from /webroot inside the
        # container. The host directory is mounted into /webroot via Docker.
        location /.well-known/acme-challenge/ {
            root /webroot;
            allow all;
        }

        # --------------------------------------------------------------------
        # HTTP → HTTPS redirect (canonical host redirection)
        # --------------------------------------------------------------------
        # All other HTTP requests are permanently redirected to HTTPS on the
        # canonical host "langkilde.se". This avoids mixed usage of
        # http/https and multiple hostnames in Google Analytics and SEO.
        location / {
            return 301 https://langkilde.se$request_uri;
        }
    }


    # ------------------------------------------------------------------------
    # HTTPS server (port 443) - canonical host, SSL, and application routing
    # ------------------------------------------------------------------------
    # This server handles all HTTPS traffic for:
    #   - langkilde.se
    #   - www.langkilde.se
    #   - daniel.langkilde.se
    #   - www.daniel.langkilde.se
    #
    # It enforces a canonical host, normalizes trailing slashes, serves the
    # Astro static site from /srv/astro, and proxies the "yatzy" apps.
    server {
        listen 443 ssl;
        http2 on;
        server_name langkilde.se www.langkilde.se daniel.langkilde.se www.daniel.langkilde.se;

        # --------------------------------------------------------------------
        # TLS certificates
        # --------------------------------------------------------------------
        # First pair: real Let's Encrypt certificate for langkilde.se.
        # Second pair: fallback self-signed certificate if LE certs are
        # missing. NGINX will use the first valid one it finds.
        ssl_certificate     /etc/letsencrypt/live/langkilde.se/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/langkilde.se/privkey.pem;

        ssl_certificate     /etc/letsencrypt/self-signed/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/self-signed/privkey.pem;

        # --------------------------------------------------------------------
        # TLS session and cipher configuration (modern defaults)
        # --------------------------------------------------------------------
        ssl_session_timeout 1d;
        ssl_session_cache   shared:MozSSL:10m;  # ~40,000 sessions
        ssl_session_tickets off;

        # SSL protocol and cipher suites based on Mozilla's "modern" config.
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers   'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers off;

        # --------------------------------------------------------------------
        # HSTS (HTTP Strict Transport Security)
        # --------------------------------------------------------------------
        # Instructs browsers to always use HTTPS for this domain for 2 years
        # (63072000 seconds). This improves security by preventing downgrade
        # attacks, but make sure you're confident HTTPS is correctly set up
        # before enabling long HSTS durations.
        add_header Strict-Transport-Security "max-age=63072000" always;


        # --------------------------------------------------------------------
        # Canonical host enforcement
        # --------------------------------------------------------------------
        # If a request comes to any host OTHER than "langkilde.se", redirect
        # permanently to "https://langkilde.se" with the same path and query.
        # This avoids fragmentation in analytics (different hostnames) and
        # improves SEO by having a single canonical base URL.
        if ($host != "langkilde.se") {
            return 301 https://langkilde.se$request_uri;
        }


        # --------------------------------------------------------------------
        # Trailing slash normalization
        # --------------------------------------------------------------------
        # Normalize URLs like:
        #   "/about/" → "/about"
        #   "/investments///" → "/investments"
        #
        # This reduces duplicate page paths in analytics and SEO. The pattern
        # captures the path without trailing slashes into $1 and redirects
        # to that, preserving any query string via $is_args$args.
        if ($request_uri ~ "^(.+)/+$") {
            return 301 https://$host$1$is_args$args;
        }


        # --------------------------------------------------------------------
        # Astro static site (primary site content)
        # --------------------------------------------------------------------
        # This location serves the static site built by Astro and copied into
        # /srv/astro. It uses:
        #   - root /srv/astro;    → document root for HTML, CSS, etc.
        #   - index index.html;   → default document
        #   - try_files $uri...   → first try exact path, then directory index,
        #                           finally return 404 if nothing matches.
        #
        # Example mapping:
        #   Request:  GET /blog/my-post
        #   Files tried (in order):
        #       /srv/astro/blog/my-post
        #       /srv/astro/blog/my-post/
        #   If /srv/astro/blog/my-post/index.html exists, it will be served.
        location / {
            root /srv/astro;
            index index.html;
            try_files $uri $uri/ =404;
        }


        # --------------------------------------------------------------------
        # yatzy-frontend: static JS bundle (libraries under /js/)
        # --------------------------------------------------------------------
        # Requests to paths starting with /js/ are proxied to the
        # "yatzy-frontend" container on port 8090, preserving the /js/ prefix.
        # Useful for sharing frontend assets across services.
        location /js/ {
            proxy_pass http://yatzy-frontend:8090/js/;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        # --------------------------------------------------------------------
        # yatzy-frontend: main frontend app under /yatzy/
        # --------------------------------------------------------------------
        # Requests to /yatzy/ are proxied to the "yatzy-frontend" service.
        # The trailing slash in proxy_pass means that:
        #   - /yatzy/ → /
        #   - /yatzy/foo → /foo
        # on the yatzy-frontend backend.
        location /yatzy/ {
            proxy_pass http://yatzy-frontend:8090/;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        # --------------------------------------------------------------------
        # yatzy-backend: API requests under /yatzy/api/
        # --------------------------------------------------------------------
        # This routes API calls under /yatzy/api/ to the "yatzy-backend"
        # service. The trailing slash in proxy_pass means that:
        #   - /yatzy/api/ → /
        #   - /yatzy/api/foo → /foo
        # on the yatzy-backend service.
        location /yatzy/api/ {
            proxy_pass http://yatzy-backend:9000/;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}